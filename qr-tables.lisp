(in-package :qr-generator)

(defvar *encoding-modes*
  '(:numeric-mode :alphanumeric-mode :byte-mode :kanji-mode)
  "Possible encoding modes from the QR code specs.")

(defvar *encoding-mode-indicators*
  (pairlis *encoding-modes* (list 1 2 4 8))
  "Numeric indicators for the encoding modes, as defined in the QR code specs.")

(defvar *count-indicator-length*
  (let ((low-range (alexandria:iota 9 :start 1))
	(mid-range (alexandria:iota 26 :start 10))
	(high-range (alexandria:iota 40 :start 27))
	(low-table (pairlis *encoding-modes* '(10 9 8 8)))
	(mid-table (pairlis *encoding-modes* '(12 11 16 10)))
	(high-table (pairlis *encoding-modes* '(14 13 16 12))))
    (loop for range in (list low-range mid-range high-range)
       for table in (list low-table mid-table high-table)
       append (loop for version in range collect (cons version table))))
  "Length of the binary representation for the character count in a given version of the QR code, and fo a given encoding mode.")

(defvar *character-capacities*
  (alexandria:alist-hash-table
   '(((1 :L :numeric-mode) . 41) ((1 :M :numeric-mode) . 34)  ((1 :Q :numeric-mode) . 27)
     ((1 :H :numeric-mode) . 17) ((2 :L :numeric-mode) . 77)  ((2 :M :numeric-mode) . 63)
     ((2 :Q :numeric-mode) . 48) ((2 :H :numeric-mode) . 34) ((3 :L :numeric-mode) . 127)
     ((3 :M :numeric-mode) . 101) ((3 :Q :numeric-mode) . 77) ((3 :H :numeric-mode) . 58)
     ((4 :L :numeric-mode) . 187) ((4 :M :numeric-mode) . 149) ((4 :Q :numeric-mode) . 111)
     ((4 :H :numeric-mode) . 82) ((5 :L :numeric-mode) . 255) ((5 :M :numeric-mode) . 202)
     ((5 :Q :numeric-mode) . 144) ((5 :H :numeric-mode) . 106) ((6 :L :numeric-mode) . 322)
     ((6 :M :numeric-mode) . 255) ((6 :Q :numeric-mode) . 178) ((6 :H :numeric-mode) . 139)
     ((7 :L :numeric-mode) . 370) ((7 :M :numeric-mode) . 293) ((7 :Q :numeric-mode) . 207)
     ((7 :H :numeric-mode) . 154) ((8 :L :numeric-mode) . 461) ((8 :M :numeric-mode) . 365)
     ((8 :Q :numeric-mode) . 259) ((8 :H :numeric-mode) . 202) ((9 :L :numeric-mode) . 552)
     ((9 :M :numeric-mode) . 432) ((9 :Q :numeric-mode) . 312) ((9 :H :numeric-mode) . 235)
     ((10 :L :numeric-mode) . 652) ((10 :M :numeric-mode) . 513) ((10 :Q :numeric-mode) . 364)
     ((10 :H :numeric-mode) . 288) ((11 :L :numeric-mode) . 772) ((11 :M :numeric-mode) . 604)
     ((11 :Q :numeric-mode) . 427) ((11 :H :numeric-mode) . 331) ((12 :L :numeric-mode) . 883)
     ((12 :M :numeric-mode) . 691) ((12 :Q :numeric-mode) . 489) ((12 :H :numeric-mode) . 374)
     ((13 :L :numeric-mode) . 1022) ((13 :M :numeric-mode) . 796) ((13 :Q :numeric-mode) . 580)
     ((13 :H :numeric-mode) . 427) ((14 :L :numeric-mode) . 1101) ((14 :M :numeric-mode) . 871)
     ((14 :Q :numeric-mode) . 621) ((14 :H :numeric-mode) . 468) ((15 :L :numeric-mode) . 1250)
     ((15 :M :numeric-mode) . 991) ((15 :Q :numeric-mode) . 703) ((15 :H :numeric-mode) . 530)
     ((16 :L :numeric-mode) . 1408) ((16 :M :numeric-mode) . 1082) ((16 :Q :numeric-mode) . 775)
     ((16 :H :numeric-mode) . 602) ((17 :L :numeric-mode) . 1548) ((17 :M :numeric-mode) . 1212)
     ((17 :Q :numeric-mode) . 876) ((17 :H :numeric-mode) . 674) ((18 :L :numeric-mode) . 1725)
     ((18 :M :numeric-mode) . 1346) ((18 :Q :numeric-mode) . 948) ((18 :H :numeric-mode) . 746)
     ((19 :L :numeric-mode) . 1903) ((19 :M :numeric-mode) . 1500) ((19 :Q :numeric-mode) . 1063)
     ((19 :H :numeric-mode) . 813) ((20 :L :numeric-mode) . 2061) ((20 :M :numeric-mode) . 1600)
     ((20 :Q :numeric-mode) . 1159) ((20 :H :numeric-mode) . 919) ((21 :L :numeric-mode) . 2232)
     ((21 :M :numeric-mode) . 1708) ((21 :Q :numeric-mode) . 1224) ((21 :H :numeric-mode) . 969)
     ((22 :L :numeric-mode) . 2409) ((22 :M :numeric-mode) . 1872) ((22 :Q :numeric-mode) . 1358)
     ((22 :H :numeric-mode) . 1056) ((23 :L :numeric-mode) . 2620) ((23 :M :numeric-mode) . 2059)
     ((23 :Q :numeric-mode) . 1468) ((23 :H :numeric-mode) . 1108) ((24 :L :numeric-mode) . 2812)
     ((24 :M :numeric-mode) . 2188) ((24 :Q :numeric-mode) . 1588) ((24 :H :numeric-mode) . 1228)
     ((25 :L :numeric-mode) . 3057) ((25 :M :numeric-mode) . 2395) ((25 :Q :numeric-mode) . 1718)
     ((25 :H :numeric-mode) . 1286) ((26 :L :numeric-mode) . 3283) ((26 :M :numeric-mode) . 2544)
     ((26 :Q :numeric-mode) . 1804) ((26 :H :numeric-mode) . 1425) ((27 :L :numeric-mode) . 3517)
     ((27 :M :numeric-mode) . 2701) ((27 :Q :numeric-mode) . 1933) ((27 :H :numeric-mode) . 1501)
     ((28 :L :numeric-mode) . 3669) ((28 :M :numeric-mode) . 2857) ((28 :Q :numeric-mode) . 2085)
     ((28 :H :numeric-mode) . 1581) ((29 :L :numeric-mode) . 3909) ((29 :M :numeric-mode) . 3035)
     ((29 :Q :numeric-mode) . 2181) ((29 :H :numeric-mode) . 1677) ((30 :L :numeric-mode) . 4158)
     ((30 :M :numeric-mode) . 3289) ((30 :Q :numeric-mode) . 2358) ((30 :H :numeric-mode) . 1782)
     ((31 :L :numeric-mode) . 4417) ((31 :M :numeric-mode) . 3486) ((31 :Q :numeric-mode) . 2473)
     ((31 :H :numeric-mode) . 1897) ((32 :L :numeric-mode) . 4686) ((32 :M :numeric-mode) . 3693)
     ((32 :Q :numeric-mode) . 2670) ((32 :H :numeric-mode) . 2022) ((33 :L :numeric-mode) . 4965)
     ((33 :M :numeric-mode) . 3909) ((33 :Q :numeric-mode) . 2805) ((33 :H :numeric-mode) . 2157)
     ((34 :L :numeric-mode) . 5253) ((34 :M :numeric-mode) . 4134) ((34 :Q :numeric-mode) . 2949)
     ((34 :H :numeric-mode) . 2301) ((35 :L :numeric-mode) . 5529) ((35 :M :numeric-mode) . 4343)
     ((35 :Q :numeric-mode) . 3081) ((35 :H :numeric-mode) . 2361) ((36 :L :numeric-mode) . 5836)
     ((36 :M :numeric-mode) . 4588) ((36 :Q :numeric-mode) . 3244) ((36 :H :numeric-mode) . 2524)
     ((37 :L :numeric-mode) . 6153) ((37 :M :numeric-mode) . 4775) ((37 :Q :numeric-mode) . 3417)
     ((37 :H :numeric-mode) . 2625) ((38 :L :numeric-mode) . 6479) ((38 :M :numeric-mode) . 5039)
     ((38 :Q :numeric-mode) . 3599) ((38 :H :numeric-mode) . 2735) ((39 :L :numeric-mode) . 6743)
     ((39 :M :numeric-mode) . 5313) ((39 :Q :numeric-mode) . 3791) ((39 :H :numeric-mode) . 2927)
     ((40 :L :numeric-mode) . 7089) ((40 :M :numeric-mode) . 5596) ((40 :Q :numeric-mode) . 3993)
     ((40 :H :numeric-mode) . 3057) ((1 :L :alphanumeric-mode) . 25) ((1 :M :alphanumeric-mode) . 20)
     ((1 :Q :alphanumeric-mode) . 16) ((1 :H :alphanumeric-mode) . 10) ((2 :L :alphanumeric-mode) . 47)
     ((2 :M :alphanumeric-mode) . 38) ((2 :Q :alphanumeric-mode) . 29) ((2 :H :alphanumeric-mode) . 20)
     ((3 :L :alphanumeric-mode) . 77) ((3 :M :alphanumeric-mode) . 61) ((3 :Q :alphanumeric-mode) . 47)
     ((3 :H :alphanumeric-mode) . 35) ((4 :L :alphanumeric-mode) . 114) ((4 :M :alphanumeric-mode) . 90)
     ((4 :Q :alphanumeric-mode) . 67) ((4 :H :alphanumeric-mode) . 50) ((5 :L :alphanumeric-mode) . 154)
     ((5 :M :alphanumeric-mode) . 122) ((5 :Q :alphanumeric-mode) . 87) ((5 :H :alphanumeric-mode) . 64)
     ((6 :L :alphanumeric-mode) . 195) ((6 :M :alphanumeric-mode) . 154) ((6 :Q :alphanumeric-mode) . 108)
     ((6 :H :alphanumeric-mode) . 84) ((7 :L :alphanumeric-mode) . 224) ((7 :M :alphanumeric-mode) . 178)
     ((7 :Q :alphanumeric-mode) . 125) ((7 :H :alphanumeric-mode) . 93) ((8 :L :alphanumeric-mode) . 279)
     ((8 :M :alphanumeric-mode) . 221) ((8 :Q :alphanumeric-mode) . 157) ((8 :H :alphanumeric-mode) . 122)
     ((9 :L :alphanumeric-mode) . 335) ((9 :M :alphanumeric-mode) . 262) ((9 :Q :alphanumeric-mode) . 189)
     ((9 :H :alphanumeric-mode) . 143) ((10 :L :alphanumeric-mode) . 395) ((10 :M :alphanumeric-mode) . 311)
     ((10 :Q :alphanumeric-mode) . 221) ((10 :H :alphanumeric-mode) . 174) ((11 :L :alphanumeric-mode) . 468)
     ((11 :M :alphanumeric-mode) . 366) ((11 :Q :alphanumeric-mode) . 259) ((11 :H :alphanumeric-mode) . 200)
     ((12 :L :alphanumeric-mode) . 535) ((12 :M :alphanumeric-mode) . 419) ((12 :Q :alphanumeric-mode) . 296)
     ((12 :H :alphanumeric-mode) . 227) ((13 :L :alphanumeric-mode) . 619) ((13 :M :alphanumeric-mode) . 483)
     ((13 :Q :alphanumeric-mode) . 352) ((13 :H :alphanumeric-mode) . 259) ((14 :L :alphanumeric-mode) . 667)
     ((14 :M :alphanumeric-mode) . 528) ((14 :Q :alphanumeric-mode) . 376) ((14 :H :alphanumeric-mode) . 283)
     ((15 :L :alphanumeric-mode) . 758) ((15 :M :alphanumeric-mode) . 600) ((15 :Q :alphanumeric-mode) . 426)
     ((15 :H :alphanumeric-mode) . 321) ((16 :L :alphanumeric-mode) . 854) ((16 :M :alphanumeric-mode) . 656)
     ((16 :Q :alphanumeric-mode) . 470) ((16 :H :alphanumeric-mode) . 365) ((17 :L :alphanumeric-mode) . 938)
     ((17 :M :alphanumeric-mode) . 734) ((17 :Q :alphanumeric-mode) . 531) ((17 :H :alphanumeric-mode) . 408)
     ((18 :L :alphanumeric-mode) . 1046) ((18 :M :alphanumeric-mode) . 816) ((18 :Q :alphanumeric-mode) . 574)
     ((18 :H :alphanumeric-mode) . 452) ((19 :L :alphanumeric-mode) . 1153) ((19 :M :alphanumeric-mode) . 909)
     ((19 :Q :alphanumeric-mode) . 644) ((19 :H :alphanumeric-mode) . 493) ((20 :L :alphanumeric-mode) . 1249)
     ((20 :M :alphanumeric-mode) . 970) ((20 :Q :alphanumeric-mode) . 702) ((20 :H :alphanumeric-mode) . 557)
     ((21 :L :alphanumeric-mode) . 1352) ((21 :M :alphanumeric-mode) . 1035) ((21 :Q :alphanumeric-mode) . 742)
     ((21 :H :alphanumeric-mode) . 587) ((22 :L :alphanumeric-mode) . 1460) ((22 :M :alphanumeric-mode) . 1134)
     ((22 :Q :alphanumeric-mode) . 823) ((22 :H :alphanumeric-mode) . 640) ((23 :L :alphanumeric-mode) . 1588)
     ((23 :M :alphanumeric-mode) . 1248) ((23 :Q :alphanumeric-mode) . 890) ((23 :H :alphanumeric-mode) . 672)
     ((24 :L :alphanumeric-mode) . 1704) ((24 :M :alphanumeric-mode) . 1326) ((24 :Q :alphanumeric-mode) . 963)
     ((24 :H :alphanumeric-mode) . 744) ((25 :L :alphanumeric-mode) . 1853) ((25 :M :alphanumeric-mode) . 1451)
     ((25 :Q :alphanumeric-mode) . 1041) ((25 :H :alphanumeric-mode) . 779) ((26 :L :alphanumeric-mode) . 1990)
     ((26 :M :alphanumeric-mode) . 1542) ((26 :Q :alphanumeric-mode) . 1094) ((26 :H :alphanumeric-mode) . 864)
     ((27 :L :alphanumeric-mode) . 2132) ((27 :M :alphanumeric-mode) . 1637) ((27 :Q :alphanumeric-mode) . 1172)
     ((27 :H :alphanumeric-mode) . 910) ((28 :L :alphanumeric-mode) . 2223) ((28 :M :alphanumeric-mode) . 1732)
     ((28 :Q :alphanumeric-mode) . 1263) ((28 :H :alphanumeric-mode) . 958) ((29 :L :alphanumeric-mode) . 2369)
     ((29 :M :alphanumeric-mode) . 1839) ((29 :Q :alphanumeric-mode) . 1322) ((29 :H :alphanumeric-mode) . 1016)
     ((30 :L :alphanumeric-mode) . 2520) ((30 :M :alphanumeric-mode) . 1994) ((30 :Q :alphanumeric-mode) . 1429)
     ((30 :H :alphanumeric-mode) . 1080) ((31 :L :alphanumeric-mode) . 2677) ((31 :M :alphanumeric-mode) . 2113)
     ((31 :Q :alphanumeric-mode) . 1499) ((31 :H :alphanumeric-mode) . 1150) ((32 :L :alphanumeric-mode) . 2840)
     ((32 :M :alphanumeric-mode) . 2238) ((32 :Q :alphanumeric-mode) . 1618) ((32 :H :alphanumeric-mode) . 1226)
     ((33 :L :alphanumeric-mode) . 3009) ((33 :M :alphanumeric-mode) . 2369) ((33 :Q :alphanumeric-mode) . 1700)
     ((33 :H :alphanumeric-mode) . 1307) ((34 :L :alphanumeric-mode) . 3183) ((34 :M :alphanumeric-mode) . 2506)
     ((34 :Q :alphanumeric-mode) . 1787) ((34 :H :alphanumeric-mode) . 1394) ((35 :L :alphanumeric-mode) . 3351)
     ((35 :M :alphanumeric-mode) . 2632) ((35 :Q :alphanumeric-mode) . 1867) ((35 :H :alphanumeric-mode) . 1431)
     ((36 :L :alphanumeric-mode) . 3537) ((36 :M :alphanumeric-mode) . 2780) ((36 :Q :alphanumeric-mode) . 1966)
     ((36 :H :alphanumeric-mode) . 1530) ((37 :L :alphanumeric-mode) . 3729) ((37 :M :alphanumeric-mode) . 2894)
     ((37 :Q :alphanumeric-mode) . 2071) ((37 :H :alphanumeric-mode) . 1591) ((38 :L :alphanumeric-mode) . 3927)
     ((38 :M :alphanumeric-mode) . 3054) ((38 :Q :alphanumeric-mode) . 2181) ((38 :H :alphanumeric-mode) . 1658)
     ((39 :L :alphanumeric-mode) . 4087) ((39 :M :alphanumeric-mode) . 3220) ((39 :Q :alphanumeric-mode) . 2298)
     ((39 :H :alphanumeric-mode) . 1774) ((40 :L :alphanumeric-mode) . 4296) ((40 :M :alphanumeric-mode) . 3391)
     ((40 :Q :alphanumeric-mode) . 2420) ((40 :H :alphanumeric-mode) . 1852) ((1 :L :byte-mode) . 17)
     ((1 :M :byte-mode) . 14) ((1 :Q :byte-mode) . 11) ((1 :H :byte-mode) . 7)
     ((2 :L :byte-mode) . 32) ((2 :M :byte-mode) . 26) ((2 :Q :byte-mode) . 20)
     ((2 :H :byte-mode) . 14) ((3 :L :byte-mode) . 53) ((3 :M :byte-mode) . 42)
     ((3 :Q :byte-mode) . 32) ((3 :H :byte-mode) . 24) ((4 :L :byte-mode) . 78)
     ((4 :M :byte-mode) . 62) ((4 :Q :byte-mode) . 46) ((4 :H :byte-mode) . 34)
     ((5 :L :byte-mode) . 106) ((5 :M :byte-mode) . 84) ((5 :Q :byte-mode) . 60)
     ((5 :H :byte-mode) . 44) ((6 :L :byte-mode) . 134) ((6 :M :byte-mode) . 106)
     ((6 :Q :byte-mode) . 74) ((6 :H :byte-mode) . 58) ((7 :L :byte-mode) . 154)
     ((7 :M :byte-mode) . 122) ((7 :Q :byte-mode) . 86) ((7 :H :byte-mode) . 64)
     ((8 :L :byte-mode) . 192) ((8 :M :byte-mode) . 152) ((8 :Q :byte-mode) . 108)
     ((8 :H :byte-mode) . 84) ((9 :L :byte-mode) . 230) ((9 :M :byte-mode) . 180)
     ((9 :Q :byte-mode) . 130) ((9 :H :byte-mode) . 98) ((10 :L :byte-mode) . 271)
     ((10 :M :byte-mode) . 213) ((10 :Q :byte-mode) . 151) ((10 :H :byte-mode) . 119)
     ((11 :L :byte-mode) . 321) ((11 :M :byte-mode) . 251) ((11 :Q :byte-mode) . 177)
     ((11 :H :byte-mode) . 137) ((12 :L :byte-mode) . 367) ((12 :M :byte-mode) . 287)
     ((12 :Q :byte-mode) . 203) ((12 :H :byte-mode) . 155) ((13 :L :byte-mode) . 425)
     ((13 :M :byte-mode) . 331) ((13 :Q :byte-mode) . 241) ((13 :H :byte-mode) . 177)
     ((14 :L :byte-mode) . 458) ((14 :M :byte-mode) . 362) ((14 :Q :byte-mode) . 258)
     ((14 :H :byte-mode) . 194) ((15 :L :byte-mode) . 520) ((15 :M :byte-mode) . 412)
     ((15 :Q :byte-mode) . 292) ((15 :H :byte-mode) . 220) ((16 :L :byte-mode) . 586)
     ((16 :M :byte-mode) . 450) ((16 :Q :byte-mode) . 322) ((16 :H :byte-mode) . 250)
     ((17 :L :byte-mode) . 644) ((17 :M :byte-mode) . 504) ((17 :Q :byte-mode) . 364)
     ((17 :H :byte-mode) . 280) ((18 :L :byte-mode) . 718) ((18 :M :byte-mode) . 560)
     ((18 :Q :byte-mode) . 394) ((18 :H :byte-mode) . 310) ((19 :L :byte-mode) . 792)
     ((19 :M :byte-mode) . 624) ((19 :Q :byte-mode) . 442) ((19 :H :byte-mode) . 338)
     ((20 :L :byte-mode) . 858) ((20 :M :byte-mode) . 666) ((20 :Q :byte-mode) . 482)
     ((20 :H :byte-mode) . 382) ((21 :L :byte-mode) . 929) ((21 :M :byte-mode) . 711)
     ((21 :Q :byte-mode) . 509) ((21 :H :byte-mode) . 403) ((22 :L :byte-mode) . 1003)
     ((22 :M :byte-mode) . 779) ((22 :Q :byte-mode) . 565) ((22 :H :byte-mode) . 439)
     ((23 :L :byte-mode) . 1091) ((23 :M :byte-mode) . 857) ((23 :Q :byte-mode) . 611)
     ((23 :H :byte-mode) . 461) ((24 :L :byte-mode) . 1171) ((24 :M :byte-mode) . 911)
     ((24 :Q :byte-mode) . 661) ((24 :H :byte-mode) . 511) ((25 :L :byte-mode) . 1273)
     ((25 :M :byte-mode) . 997) ((25 :Q :byte-mode) . 715) ((25 :H :byte-mode) . 535)
     ((26 :L :byte-mode) . 1367) ((26 :M :byte-mode) . 1059) ((26 :Q :byte-mode) . 751)
     ((26 :H :byte-mode) . 593) ((27 :L :byte-mode) . 1465) ((27 :M :byte-mode) . 1125)
     ((27 :Q :byte-mode) . 805) ((27 :H :byte-mode) . 625) ((28 :L :byte-mode) . 1528)
     ((28 :M :byte-mode) . 1190) ((28 :Q :byte-mode) . 868) ((28 :H :byte-mode) . 658)
     ((29 :L :byte-mode) . 1628) ((29 :M :byte-mode) . 1264) ((29 :Q :byte-mode) . 908)
     ((29 :H :byte-mode) . 698) ((30 :L :byte-mode) . 1732) ((30 :M :byte-mode) . 1370)
     ((30 :Q :byte-mode) . 982) ((30 :H :byte-mode) . 742) ((31 :L :byte-mode) . 1840)
     ((31 :M :byte-mode) . 1452) ((31 :Q :byte-mode) . 1030) ((31 :H :byte-mode) . 790)
     ((32 :L :byte-mode) . 1952) ((32 :M :byte-mode) . 1538) ((32 :Q :byte-mode) . 1112)
     ((32 :H :byte-mode) . 842) ((33 :L :byte-mode) . 2068) ((33 :M :byte-mode) . 1628)
     ((33 :Q :byte-mode) . 1168) ((33 :H :byte-mode) . 898) ((34 :L :byte-mode) . 2188)
     ((34 :M :byte-mode) . 1722) ((34 :Q :byte-mode) . 1228) ((34 :H :byte-mode) . 958)
     ((35 :L :byte-mode) . 2303) ((35 :M :byte-mode) . 1809) ((35 :Q :byte-mode) . 1283)
     ((35 :H :byte-mode) . 983) ((36 :L :byte-mode) . 2431) ((36 :M :byte-mode) . 1911)
     ((36 :Q :byte-mode) . 1351) ((36 :H :byte-mode) . 1051) ((37 :L :byte-mode) . 2563)
     ((37 :M :byte-mode) . 1989) ((37 :Q :byte-mode) . 1423) ((37 :H :byte-mode) . 1093)
     ((38 :L :byte-mode) . 2699) ((38 :M :byte-mode) . 2099) ((38 :Q :byte-mode) . 1499)
     ((38 :H :byte-mode) . 1139) ((39 :L :byte-mode) . 2809) ((39 :M :byte-mode) . 2213)
     ((39 :Q :byte-mode) . 1579) ((39 :H :byte-mode) . 1219) ((40 :L :byte-mode) . 2953)
     ((40 :M :byte-mode) . 2331) ((40 :Q :byte-mode) . 1663) ((40 :H :byte-mode) . 1273)
     ((1 :L :kanji-mode) . 10) ((1 :M :kanji-mode) . 8) ((1 :Q :kanji-mode) . 7)
     ((1 :H :kanji-mode) . 4) ((2 :L :kanji-mode) . 20) ((2 :M :kanji-mode) . 16)
     ((2 :Q :kanji-mode) . 12) ((2 :H :kanji-mode) . 8) ((3 :L :kanji-mode) . 32)
     ((3 :M :kanji-mode) . 26) ((3 :Q :kanji-mode) . 20) ((3 :H :kanji-mode) . 15)
     ((4 :L :kanji-mode) . 48) ((4 :M :kanji-mode) . 38) ((4 :Q :kanji-mode) . 28)
     ((4 :H :kanji-mode) . 21) ((5 :L :kanji-mode) . 65) ((5 :M :kanji-mode) . 52)
     ((5 :Q :kanji-mode) . 37) ((5 :H :kanji-mode) . 27) ((6 :L :kanji-mode) . 82)
     ((6 :M :kanji-mode) . 65) ((6 :Q :kanji-mode) . 45) ((6 :H :kanji-mode) . 36)
     ((7 :L :kanji-mode) . 95) ((7 :M :kanji-mode) . 75) ((7 :Q :kanji-mode) . 53)
     ((7 :H :kanji-mode) . 39) ((8 :L :kanji-mode) . 118) ((8 :M :kanji-mode) . 93)
     ((8 :Q :kanji-mode) . 66) ((8 :H :kanji-mode) . 52) ((9 :L :kanji-mode) . 141)
     ((9 :M :kanji-mode) . 111) ((9 :Q :kanji-mode) . 80) ((9 :H :kanji-mode) . 60)
     ((10 :L :kanji-mode) . 167) ((10 :M :kanji-mode) . 131) ((10 :Q :kanji-mode) . 93)
     ((10 :H :kanji-mode) . 74) ((11 :L :kanji-mode) . 198) ((11 :M :kanji-mode) . 155)
     ((11 :Q :kanji-mode) . 109) ((11 :H :kanji-mode) . 85) ((12 :L :kanji-mode) . 226)
     ((12 :M :kanji-mode) . 177) ((12 :Q :kanji-mode) . 125) ((12 :H :kanji-mode) . 96)
     ((13 :L :kanji-mode) . 262) ((13 :M :kanji-mode) . 204) ((13 :Q :kanji-mode) . 149)
     ((13 :H :kanji-mode) . 109) ((14 :L :kanji-mode) . 282) ((14 :M :kanji-mode) . 223)
     ((14 :Q :kanji-mode) . 159) ((14 :H :kanji-mode) . 120) ((15 :L :kanji-mode) . 320)
     ((15 :M :kanji-mode) . 254) ((15 :Q :kanji-mode) . 180) ((15 :H :kanji-mode) . 136)
     ((16 :L :kanji-mode) . 361) ((16 :M :kanji-mode) . 277) ((16 :Q :kanji-mode) . 198)
     ((16 :H :kanji-mode) . 154) ((17 :L :kanji-mode) . 397) ((17 :M :kanji-mode) . 310)
     ((17 :Q :kanji-mode) . 224) ((17 :H :kanji-mode) . 173) ((18 :L :kanji-mode) . 442)
     ((18 :M :kanji-mode) . 345) ((18 :Q :kanji-mode) . 243) ((18 :H :kanji-mode) . 191)
     ((19 :L :kanji-mode) . 488) ((19 :M :kanji-mode) . 384) ((19 :Q :kanji-mode) . 272)
     ((19 :H :kanji-mode) . 208) ((20 :L :kanji-mode) . 528) ((20 :M :kanji-mode) . 410)
     ((20 :Q :kanji-mode) . 297) ((20 :H :kanji-mode) . 235) ((21 :L :kanji-mode) . 572)
     ((21 :M :kanji-mode) . 438) ((21 :Q :kanji-mode) . 314) ((21 :H :kanji-mode) . 248)
     ((22 :L :kanji-mode) . 618) ((22 :M :kanji-mode) . 480) ((22 :Q :kanji-mode) . 348)
     ((22 :H :kanji-mode) . 270) ((23 :L :kanji-mode) . 672) ((23 :M :kanji-mode) . 528)
     ((23 :Q :kanji-mode) . 376) ((23 :H :kanji-mode) . 284) ((24 :L :kanji-mode) . 721)
     ((24 :M :kanji-mode) . 561) ((24 :Q :kanji-mode) . 407) ((24 :H :kanji-mode) . 315)
     ((25 :L :kanji-mode) . 784) ((25 :M :kanji-mode) . 614) ((25 :Q :kanji-mode) . 440)
     ((25 :H :kanji-mode) . 330) ((26 :L :kanji-mode) . 842) ((26 :M :kanji-mode) . 652)
     ((26 :Q :kanji-mode) . 462) ((26 :H :kanji-mode) . 365) ((27 :L :kanji-mode) . 902)
     ((27 :M :kanji-mode) . 692) ((27 :Q :kanji-mode) . 496) ((27 :H :kanji-mode) . 385)
     ((28 :L :kanji-mode) . 940) ((28 :M :kanji-mode) . 732) ((28 :Q :kanji-mode) . 534)
     ((28 :H :kanji-mode) . 405) ((29 :L :kanji-mode) . 1002) ((29 :M :kanji-mode) . 778)
     ((29 :Q :kanji-mode) . 559) ((29 :H :kanji-mode) . 430) ((30 :L :kanji-mode) . 1066)
     ((30 :M :kanji-mode) . 843) ((30 :Q :kanji-mode) . 604) ((30 :H :kanji-mode) . 457)
     ((31 :L :kanji-mode) . 1132) ((31 :M :kanji-mode) . 894) ((31 :Q :kanji-mode) . 634)
     ((31 :H :kanji-mode) . 486) ((32 :L :kanji-mode) . 1201) ((32 :M :kanji-mode) . 947)
     ((32 :Q :kanji-mode) . 684) ((32 :H :kanji-mode) . 518) ((33 :L :kanji-mode) . 1273)
     ((33 :M :kanji-mode) . 1002) ((33 :Q :kanji-mode) . 719) ((33 :H :kanji-mode) . 553)
     ((34 :L :kanji-mode) . 1347) ((34 :M :kanji-mode) . 1060) ((34 :Q :kanji-mode) . 756)
     ((34 :H :kanji-mode) . 590) ((35 :L :kanji-mode) . 1417) ((35 :M :kanji-mode) . 1113)
     ((35 :Q :kanji-mode) . 790) ((35 :H :kanji-mode) . 605) ((36 :L :kanji-mode) . 1496)
     ((36 :M :kanji-mode) . 1176) ((36 :Q :kanji-mode) . 832) ((36 :H :kanji-mode) . 647)
     ((37 :L :kanji-mode) . 1577) ((37 :M :kanji-mode) . 1224) ((37 :Q :kanji-mode) . 876)
     ((37 :H :kanji-mode) . 673) ((38 :L :kanji-mode) . 1661) ((38 :M :kanji-mode) . 1292)
     ((38 :Q :kanji-mode) . 923) ((38 :H :kanji-mode) . 701) ((39 :L :kanji-mode) . 1729)
     ((39 :M :kanji-mode) . 1362) ((39 :Q :kanji-mode) . 972) ((39 :H :kanji-mode) . 750)
     ((40 :L :kanji-mode) . 1817) ((40 :M :kanji-mode) . 1435) ((40 :Q :kanji-mode) . 1024)
     ((40 :H :kanji-mode) . 784))
   :test #'equalp)
  "Number of bits possibly containes in a given version of a QR code, for a given error correction mode and a given encoding mode.")

(defvar *alphanumeric-encoding*
  (alexandria:alist-hash-table
   '((#\0 . 0) (#\1 . 1) (#\2 . 2) (#\3 . 3) (#\4 . 4) (#\5 . 5) (#\6 . 6) (#\7 . 7)
     (#\8 . 8) (#\9 . 9) (#\A . 10) (#\B . 11) (#\C . 12) (#\D . 13) (#\E . 14) (#\F . 15)
     (#\G . 16) (#\H . 17) (#\I . 18) (#\J . 19) (#\K . 20) (#\L . 21) (#\M . 22) (#\N . 23)
     (#\O . 24) (#\P . 25) (#\Q . 26) (#\R . 27) (#\S . 28) (#\T . 29) (#\U . 30) (#\V . 31)
     (#\W . 32) (#\X . 33) (#\Y . 34) (#\Z . 35) (#\Space . 36) (#\$ . 37) (#\% . 38) (#\* . 39)
     (#\+ . 40) (#\- . 41) (#\. . 42) (#\/ . 43) (#\: . 44)))
  "Encoding table for :alphanumeric-mode encoding mode")

(defvar *codewords*
  (alexandria:alist-hash-table
   '(((1 :L) . (:total-codewords 19 :ec-codewords 7))
     ((1 :M) . (:total-codewords 16 :ec-codewords 10))
     ((1 :Q) . (:total-codewords 13 :ec-codewords 13))
     ((1 :H) . (:total-codewords 9 :ec-codewords 17))
     ((2 :L) . (:total-codewords 34 :ec-codewords 10))
     ((2 :M) . (:total-codewords 28 :ec-codewords 16))
     ((2 :Q) . (:total-codewords 22 :ec-codewords 22))
     ((2 :H) . (:total-codewords 16 :ec-codewords 28))
     ((3 :L) . (:total-codewords 55 :ec-codewords 15))
     ((3 :M) . (:total-codewords 44 :ec-codewords 26))
     ((3 :Q) . (:total-codewords 34 :ec-codewords 18))
     ((3 :H) . (:total-codewords 26 :ec-codewords 22))
     ((4 :L) . (:total-codewords 80 :ec-codewords 20))
     ((4 :M) . (:total-codewords 64 :ec-codewords 18))
     ((4 :Q) . (:total-codewords 48 :ec-codewords 26))
     ((4 :H) . (:total-codewords 36 :ec-codewords 16))
     ((5 :L) . (:total-codewords 108 :ec-codewords 26))
     ((5 :M) . (:total-codewords 86 :ec-codewords 24))
     ((5 :Q) . (:total-codewords 62 :ec-codewords 18))
     ((5 :H) . (:total-codewords 46 :ec-codewords 22))
     ((6 :L) . (:total-codewords 136 :ec-codewords 18))
     ((6 :M) . (:total-codewords 108 :ec-codewords 16))
     ((6 :Q) . (:total-codewords 76 :ec-codewords 24))
     ((6 :H) . (:total-codewords 60 :ec-codewords 28))
     ((7 :L) . (:total-codewords 156 :ec-codewords 20))
     ((7 :M) . (:total-codewords 124 :ec-codewords 18))
     ((7 :Q) . (:total-codewords 88 :ec-codewords 18))
     ((7 :H) . (:total-codewords 66 :ec-codewords 26))
     ((8 :L) . (:total-codewords 194 :ec-codewords 24))
     ((8 :M) . (:total-codewords 154 :ec-codewords 22))
     ((8 :Q) . (:total-codewords 110 :ec-codewords 22))
     ((8 :H) . (:total-codewords 86 :ec-codewords 26))
     ((9 :L) . (:total-codewords 232 :ec-codewords 30))
     ((9 :M) . (:total-codewords 182 :ec-codewords 22))
     ((9 :Q) . (:total-codewords 132 :ec-codewords 20))
     ((9 :H) . (:total-codewords 100 :ec-codewords 24))
     ((10 :L). (:total-codewords 274 :ec-codewords 18))
     ((10 :M). (:total-codewords 216 :ec-codewords 26))
     ((10 :Q). (:total-codewords 154 :ec-codewords 24))
     ((10 :H). (:total-codewords 122 :ec-codewords 28))
     ((11 :L). (:total-codewords 324 :ec-codewords 20))
     ((11 :M). (:total-codewords 254 :ec-codewords 30))
     ((11 :Q). (:total-codewords 180 :ec-codewords 28))
     ((11 :H). (:total-codewords 140 :ec-codewords 24))
     ((12 :L). (:total-codewords 370 :ec-codewords 24))
     ((12 :M). (:total-codewords 290 :ec-codewords 22))
     ((12 :Q). (:total-codewords 206 :ec-codewords 26))
     ((12 :H). (:total-codewords 158 :ec-codewords 28))
     ((13 :L). (:total-codewords 428 :ec-codewords 26))
     ((13 :M). (:total-codewords 334 :ec-codewords 22))
     ((13 :Q). (:total-codewords 244 :ec-codewords 24))
     ((13 :H). (:total-codewords 180 :ec-codewords 22))
     ((14 :L). (:total-codewords 461 :ec-codewords 30))
     ((14 :M). (:total-codewords 365 :ec-codewords 24))
     ((14 :Q). (:total-codewords 261 :ec-codewords 20))
     ((14 :H). (:total-codewords 197 :ec-codewords 24))
     ((15 :L). (:total-codewords 523 :ec-codewords 22))
     ((15 :M). (:total-codewords 415 :ec-codewords 24))
     ((15 :Q). (:total-codewords 295 :ec-codewords 30))
     ((15 :H). (:total-codewords 223 :ec-codewords 24))
     ((16 :L). (:total-codewords 589 :ec-codewords 24))
     ((16 :M). (:total-codewords 453 :ec-codewords 28))
     ((16 :Q). (:total-codewords 325 :ec-codewords 24))
     ((16 :H). (:total-codewords 253 :ec-codewords 30))
     ((17 :L). (:total-codewords 647 :ec-codewords 28))
     ((17 :M). (:total-codewords 507 :ec-codewords 28))
     ((17 :Q). (:total-codewords 367 :ec-codewords 28))
     ((17 :H). (:total-codewords 283 :ec-codewords 28))
     ((18 :L). (:total-codewords 721 :ec-codewords 30))
     ((18 :M). (:total-codewords 563 :ec-codewords 26))
     ((18 :Q). (:total-codewords 397 :ec-codewords 28))
     ((18 :H). (:total-codewords 313 :ec-codewords 28))
     ((19 :L). (:total-codewords 795 :ec-codewords 28))
     ((19 :M). (:total-codewords 627 :ec-codewords 26))
     ((19 :Q). (:total-codewords 445 :ec-codewords 26))
     ((19 :H). (:total-codewords 341 :ec-codewords 26))
     ((20 :L). (:total-codewords 861 :ec-codewords 28))
     ((20 :M). (:total-codewords 669 :ec-codewords 26))
     ((20 :Q). (:total-codewords 485 :ec-codewords 30))
     ((20 :H). (:total-codewords 385 :ec-codewords 28))
     ((21 :L). (:total-codewords 932 :ec-codewords 28))
     ((21 :M). (:total-codewords 714 :ec-codewords 26))
     ((21 :Q). (:total-codewords 512 :ec-codewords 28))
     ((21 :H). (:total-codewords 406 :ec-codewords 30))
     ((22 :L). (:total-codewords 1006 :ec-codewords 28))
     ((22 :M). (:total-codewords 782 :ec-codewords 28))
     ((22 :Q). (:total-codewords 568 :ec-codewords 30))
     ((22 :H). (:total-codewords 442 :ec-codewords 24))
     ((23 :L). (:total-codewords 1094 :ec-codewords 30))
     ((23 :M). (:total-codewords 860 :ec-codewords 28))
     ((23 :Q). (:total-codewords 614 :ec-codewords 30))
     ((23 :H). (:total-codewords 464 :ec-codewords 30))
     ((24 :L). (:total-codewords 1174 :ec-codewords 30))
     ((24 :M). (:total-codewords 914 :ec-codewords 28))
     ((24 :Q). (:total-codewords 664 :ec-codewords 30))
     ((24 :H). (:total-codewords 514 :ec-codewords 30))
     ((25 :L). (:total-codewords 1276 :ec-codewords 26))
     ((25 :M). (:total-codewords 1000 :ec-codewords 28))
     ((25 :Q). (:total-codewords 718 :ec-codewords 30))
     ((25 :H). (:total-codewords 538 :ec-codewords 30))
     ((26 :L). (:total-codewords 1370 :ec-codewords 28))
     ((26 :M). (:total-codewords 1062 :ec-codewords 28))
     ((26 :Q). (:total-codewords 754 :ec-codewords 28))
     ((26 :H). (:total-codewords 596 :ec-codewords 30))
     ((27 :L). (:total-codewords 1468 :ec-codewords 30))
     ((27 :M). (:total-codewords 1128 :ec-codewords 28))
     ((27 :Q). (:total-codewords 808 :ec-codewords 30))
     ((27 :H). (:total-codewords 628 :ec-codewords 30))
     ((28 :L). (:total-codewords 1531 :ec-codewords 30))
     ((28 :M). (:total-codewords 1193 :ec-codewords 28))
     ((28 :Q). (:total-codewords 871 :ec-codewords 30))
     ((28 :H). (:total-codewords 661 :ec-codewords 30))
     ((29 :L). (:total-codewords 1631 :ec-codewords 30))
     ((29 :M). (:total-codewords 1267 :ec-codewords 28))
     ((29 :Q). (:total-codewords 911 :ec-codewords 30))
     ((29 :H). (:total-codewords 701 :ec-codewords 30))
     ((30 :L). (:total-codewords 1735 :ec-codewords 30))
     ((30 :M). (:total-codewords 1373 :ec-codewords 28))
     ((30 :Q). (:total-codewords 985 :ec-codewords 30))
     ((30 :H). (:total-codewords 745 :ec-codewords 30))
     ((31 :L). (:total-codewords 1843 :ec-codewords 30))
     ((31 :M). (:total-codewords 1455 :ec-codewords 28))
     ((31 :Q). (:total-codewords 1033 :ec-codewords 30))
     ((31 :H). (:total-codewords 793 :ec-codewords 30))
     ((32 :L). (:total-codewords 1955 :ec-codewords 30))
     ((32 :M). (:total-codewords 1541 :ec-codewords 28))
     ((32 :Q). (:total-codewords 1115 :ec-codewords 30))
     ((32 :H). (:total-codewords 845 :ec-codewords 30))
     ((33 :L). (:total-codewords 2071 :ec-codewords 30))
     ((33 :M). (:total-codewords 1631 :ec-codewords 28))
     ((33 :Q). (:total-codewords 1171 :ec-codewords 30))
     ((33 :H). (:total-codewords 901 :ec-codewords 30))
     ((34 :L). (:total-codewords 2191 :ec-codewords 30))
     ((34 :M). (:total-codewords 1725 :ec-codewords 28))
     ((34 :Q). (:total-codewords 1231 :ec-codewords 30))
     ((34 :H). (:total-codewords 961 :ec-codewords 30))
     ((35 :L). (:total-codewords 2306 :ec-codewords 30))
     ((35 :M). (:total-codewords 1812 :ec-codewords 28))
     ((35 :Q). (:total-codewords 1286 :ec-codewords 30))
     ((35 :H). (:total-codewords 986 :ec-codewords 30))
     ((36 :L). (:total-codewords 2434 :ec-codewords 30))
     ((36 :M). (:total-codewords 1914 :ec-codewords 28))
     ((36 :Q). (:total-codewords 1354 :ec-codewords 30))
     ((36 :H). (:total-codewords 1054 :ec-codewords 30))
     ((37 :L). (:total-codewords 2566 :ec-codewords 30))
     ((37 :M). (:total-codewords 1992 :ec-codewords 28))
     ((37 :Q). (:total-codewords 1426 :ec-codewords 30))
     ((37 :H). (:total-codewords 1096 :ec-codewords 30))
     ((38 :L). (:total-codewords 2702 :ec-codewords 30))
     ((38 :M). (:total-codewords 2102 :ec-codewords 28))
     ((38 :Q). (:total-codewords 1502 :ec-codewords 30))
     ((38 :H). (:total-codewords 1142 :ec-codewords 30))
     ((39 :L). (:total-codewords 2812 :ec-codewords 30))
     ((39 :M). (:total-codewords 2216 :ec-codewords 28))
     ((39 :Q). (:total-codewords 1582 :ec-codewords 30))
     ((39 :H). (:total-codewords 1222 :ec-codewords 30))
     ((40 :L). (:total-codewords 2956 :ec-codewords 30))
     ((40 :M). (:total-codewords 2334 :ec-codewords 28))
     ((40 :Q). (:total-codewords 1666 :ec-codewords 30))
     ((40 :H). (:total-codewords 1276 :ec-codewords 30)))
   :test #'equalp))

(defvar *log-antilog*
  (loop for i below 256
     with result-vector = (make-array 256)
     for j = 1 then (if (< 255 (* 2 j))
			(logxor (* 2 j) 285)
			(* 2 j))
     do (setf (aref result-vector i) j)
     finally (return result-vector))
  "Galois Field")

(defvar *block-information*
  (alexandria:alist-hash-table
   '(((1 :L) . (:blocks-in-g1 1 :words-in-b1 19))
     ((1 :M) . (:blocks-in-g1 1 :words-in-b1 16))
     ((1 :Q) . (:blocks-in-g1 1 :words-in-b1 13))
     ((1 :H) . (:blocks-in-g1 1 :words-in-b1 9))
     ((2 :L) . (:blocks-in-g1 1 :words-in-b1 34))
     ((2 :M) . (:blocks-in-g1 1 :words-in-b1 28))
     ((2 :Q) . (:blocks-in-g1 1 :words-in-b1 22))
     ((2 :H) . (:blocks-in-g1 1 :words-in-b1 16))
     ((3 :L) . (:blocks-in-g1 1 :words-in-b1 55))
     ((3 :M) . (:blocks-in-g1 1 :words-in-b1 44))
     ((3 :Q) . (:blocks-in-g1 2 :words-in-b1 17))
     ((3 :H) . (:blocks-in-g1 2 :words-in-b1 13))
     ((4 :L) . (:blocks-in-g1 1 :words-in-b1 80))
     ((4 :M) . (:blocks-in-g1 2 :words-in-b1 32))
     ((4 :Q) . (:blocks-in-g1 2 :words-in-b1 24))
     ((4 :H) . (:blocks-in-g1 4 :words-in-b1 9))
     ((5 :L) . (:blocks-in-g1 1 :words-in-b1 108))
     ((5 :M) . (:blocks-in-g1 2 :words-in-b1 43))
     ((5 :Q) . (:blocks-in-g1 2 :words-in-b1 15 :blocks-in-g2 2 :words-in-b2 16))
     ((5 :H) . (:blocks-in-g1 2 :words-in-b1 11 :blocks-in-g2 2 :words-in-b2 12))
     ((6 :L) . (:blocks-in-g1 2 :words-in-b1 68))
     ((6 :M) . (:blocks-in-g1 4 :words-in-b1 27))
     ((6 :Q) . (:blocks-in-g1 4 :words-in-b1 19))
     ((6 :H) . (:blocks-in-g1 4 :words-in-b1 15))
     ((7 :L) . (:blocks-in-g1 2 :words-in-b1 78))
     ((7 :M) . (:blocks-in-g1 4 :words-in-b1 31))
     ((7 :Q) . (:blocks-in-g1 2 :words-in-b1 14 :blocks-in-g2 4 :words-in-b2 15))
     ((7 :H) . (:blocks-in-g1 4 :words-in-b1 13 :blocks-in-g2 1 :words-in-b2 14))
     ((8 :L) . (:blocks-in-g1 2 :words-in-b1 97))
     ((8 :M) . (:blocks-in-g1 2 :words-in-b1 38 :blocks-in-g2 2 :words-in-b2 39))
     ((8 :Q) . (:blocks-in-g1 4 :words-in-b1 18 :blocks-in-g2 2 :words-in-b2 19))
     ((8 :H) . (:blocks-in-g1 4 :words-in-b1 14 :blocks-in-g2 2 :words-in-b2 15))
     ((9 :L) . (:blocks-in-g1 2 :words-in-b1 116))
     ((9 :M) . (:blocks-in-g1 3 :words-in-b1 36 :blocks-in-g2 2 :words-in-b2 37))
     ((9 :Q) . (:blocks-in-g1 4 :words-in-b1 16 :blocks-in-g2 4 :words-in-b2 17))
     ((9 :H) . (:blocks-in-g1 4 :words-in-b1 12 :blocks-in-g2 4 :words-in-b2 13))
     ((10 :L) . (:blocks-in-g1 2 :words-in-b1 68 :blocks-in-g2 2 :words-in-b2 69))
     ((10 :M) . (:blocks-in-g1 4 :words-in-b1 43 :blocks-in-g2 1 :words-in-b2 44))
     ((10 :Q) . (:blocks-in-g1 6 :words-in-b1 19 :blocks-in-g2 2 :words-in-b2 20))
     ((10 :H) . (:blocks-in-g1 6 :words-in-b1 15 :blocks-in-g2 2 :words-in-b2 16))
     ((11 :L) . (:blocks-in-g1 4 :words-in-b1 81))
     ((11 :M) . (:blocks-in-g1 1 :words-in-b1 50 :blocks-in-g2 4 :words-in-b2 51))
     ((11 :Q) . (:blocks-in-g1 4 :words-in-b1 22 :blocks-in-g2 4 :words-in-b2 23))
     ((11 :H) . (:blocks-in-g1 3 :words-in-b1 12 :blocks-in-g2 8 :words-in-b2 13))
     ((12 :L) . (:blocks-in-g1 2 :words-in-b1 92 :blocks-in-g2 2 :words-in-b2 93))
     ((12 :M) . (:blocks-in-g1 6 :words-in-b1 36 :blocks-in-g2 2 :words-in-b2 37))
     ((12 :Q) . (:blocks-in-g1 4 :words-in-b1 20 :blocks-in-g2 6 :words-in-b2 21))
     ((12 :H) . (:blocks-in-g1 7 :words-in-b1 14 :blocks-in-g2 4 :words-in-b2 15))
     ((13 :L) . (:blocks-in-g1 4 :words-in-b1 107    ))
     ((13 :M) . (:blocks-in-g1 8 :words-in-b1 37 :blocks-in-g2 1 :words-in-b2 38))
     ((13 :Q) . (:blocks-in-g1 8 :words-in-b1 20 :blocks-in-g2 4 :words-in-b2 21))
     ((13 :H) . (:blocks-in-g1 12 :words-in-b1 11 :blocks-in-g2 4 :words-in-b2 12))
     ((14 :L) . (:blocks-in-g1 3 :words-in-b1 115 :blocks-in-g2 1 :words-in-b2 116))
     ((14 :M) . (:blocks-in-g1 4 :words-in-b1 40 :blocks-in-g2 5 :words-in-b2 41))
     ((14 :Q) . (:blocks-in-g1 11 :words-in-b1 16 :blocks-in-g2 5 :words-in-b2 17))
     ((14 :H) . (:blocks-in-g1 11 :words-in-b1 12 :blocks-in-g2 5 :words-in-b2 13))
     ((15 :L) . (:blocks-in-g1 5 :words-in-b1 87 :blocks-in-g2 1 :words-in-b2 88))
     ((15 :M) . (:blocks-in-g1 5 :words-in-b1 41 :blocks-in-g2 5 :words-in-b2 42))
     ((15 :Q) . (:blocks-in-g1 5 :words-in-b1 24 :blocks-in-g2 7 :words-in-b2 25))
     ((15 :H) . (:blocks-in-g1 11 :words-in-b1 12 :blocks-in-g2 7 :words-in-b2 13))
     ((16 :L) . (:blocks-in-g1 5 :words-in-b1 98 :blocks-in-g2 1 :words-in-b2 99))
     ((16 :M) . (:blocks-in-g1 7 :words-in-b1 45 :blocks-in-g2 3 :words-in-b2 46))
     ((16 :Q) . (:blocks-in-g1 15 :words-in-b1 19 :blocks-in-g2 2 :words-in-b2 20))
     ((16 :H) . (:blocks-in-g1 3 :words-in-b1 15 :blocks-in-g2 13 :words-in-b2 16))
     ((17 :L) . (:blocks-in-g1 1 :words-in-b1 107 :blocks-in-g2 5 :words-in-b2 108))
     ((17 :M) . (:blocks-in-g1 10 :words-in-b1 46 :blocks-in-g2 1 :words-in-b2 47))
     ((17 :Q) . (:blocks-in-g1 1 :words-in-b1 22 :blocks-in-g2 15 :words-in-b2 23))
     ((17 :H) . (:blocks-in-g1 2 :words-in-b1 14 :blocks-in-g2 17 :words-in-b2 15))
     ((18 :L) . (:blocks-in-g1 5 :words-in-b1 120 :blocks-in-g2 1 :words-in-b2 121))
     ((18 :M) . (:blocks-in-g1 9 :words-in-b1 43 :blocks-in-g2 4 :words-in-b2 44))
     ((18 :Q) . (:blocks-in-g1 17 :words-in-b1 22 :blocks-in-g2 1 :words-in-b2 23))
     ((18 :H) . (:blocks-in-g1 2 :words-in-b1 14 :blocks-in-g2 19 :words-in-b2 15))
     ((19 :L) . (:blocks-in-g1 3 :words-in-b1 113 :blocks-in-g2 4 :words-in-b2 114))
     ((19 :M) . (:blocks-in-g1 3 :words-in-b1 44 :blocks-in-g2 11 :words-in-b2 45))
     ((19 :Q) . (:blocks-in-g1 17 :words-in-b1 21 :blocks-in-g2 4 :words-in-b2 22))
     ((19 :H) . (:blocks-in-g1 9 :words-in-b1 13 :blocks-in-g2 16 :words-in-b2 14))
     ((20 :L) . (:blocks-in-g1 3 :words-in-b1 107 :blocks-in-g2 5 :words-in-b2 108))
     ((20 :M) . (:blocks-in-g1 3 :words-in-b1 41 :blocks-in-g2 13 :words-in-b2 42))
     ((20 :Q) . (:blocks-in-g1 15 :words-in-b1 24 :blocks-in-g2 5 :words-in-b2 25))
     ((20 :H) . (:blocks-in-g1 15 :words-in-b1 15 :blocks-in-g2 10 :words-in-b2 16))
     ((21 :L) . (:blocks-in-g1 4 :words-in-b1 116 :blocks-in-g2 4 :words-in-b2 117))
     ((21 :M) . (:blocks-in-g1 17 :words-in-b1 42))
     ((21 :Q) . (:blocks-in-g1 17 :words-in-b1 22 :blocks-in-g2 6 :words-in-b2 23))
     ((21 :H) . (:blocks-in-g1 19 :words-in-b1 16 :blocks-in-g2 6 :words-in-b2 17))
     ((22 :L) . (:blocks-in-g1 2 :words-in-b1 111 :blocks-in-g2 7 :words-in-b2 112))
     ((22 :M) . (:blocks-in-g1 17 :words-in-b1 46))
     ((22 :Q) . (:blocks-in-g1 7 :words-in-b1 24 :blocks-in-g2 16 :words-in-b2 25))
     ((22 :H) . (:blocks-in-g1 34 :words-in-b1 13))
     ((23 :L) . (:blocks-in-g1 4 :words-in-b1 121 :blocks-in-g2 5 :words-in-b2 122))
     ((23 :M) . (:blocks-in-g1 4 :words-in-b1 47 :blocks-in-g2 14 :words-in-b2 48))
     ((23 :Q) . (:blocks-in-g1 11 :words-in-b1 24 :blocks-in-g2 14 :words-in-b2 25))
     ((23 :H) . (:blocks-in-g1 16 :words-in-b1 15 :blocks-in-g2 14 :words-in-b2 16))
     ((24 :L) . (:blocks-in-g1 6 :words-in-b1 117 :blocks-in-g2 4 :words-in-b2 118))
     ((24 :M) . (:blocks-in-g1 6 :words-in-b1 45 :blocks-in-g2 14 :words-in-b2 46))
     ((24 :Q) . (:blocks-in-g1 11 :words-in-b1 24 :blocks-in-g2 16 :words-in-b2 25))
     ((24 :H) . (:blocks-in-g1 30 :words-in-b1 16 :blocks-in-g2 2 :words-in-b2 17))
     ((25 :L) . (:blocks-in-g1 8 :words-in-b1 106 :blocks-in-g2 4 :words-in-b2 107))
     ((25 :M) . (:blocks-in-g1 8 :words-in-b1 47 :blocks-in-g2 13 :words-in-b2 48))
     ((25 :Q) . (:blocks-in-g1 7 :words-in-b1 24 :blocks-in-g2 22 :words-in-b2 25))
     ((25 :H) . (:blocks-in-g1 22 :words-in-b1 15 :blocks-in-g2 13 :words-in-b2 16))
     ((26 :L) . (:blocks-in-g1 10 :words-in-b1 114 :blocks-in-g2 2 :words-in-b2 115))
     ((26 :M) . (:blocks-in-g1 19 :words-in-b1 46 :blocks-in-g2 4 :words-in-b2 47))
     ((26 :Q) . (:blocks-in-g1 28 :words-in-b1 22 :blocks-in-g2 6 :words-in-b2 23))
     ((26 :H) . (:blocks-in-g1 33 :words-in-b1 16 :blocks-in-g2 4 :words-in-b2 17))
     ((27 :L) . (:blocks-in-g1 8 :words-in-b1 122 :blocks-in-g2 4 :words-in-b2 123))
     ((27 :M) . (:blocks-in-g1 22 :words-in-b1 45 :blocks-in-g2 3 :words-in-b2 46))
     ((27 :Q) . (:blocks-in-g1 8 :words-in-b1 23 :blocks-in-g2 26 :words-in-b2 24))
     ((27 :H) . (:blocks-in-g1 12 :words-in-b1 15 :blocks-in-g2 28 :words-in-b2 16))
     ((28 :L) . (:blocks-in-g1 3 :words-in-b1 117 :blocks-in-g2 10 :words-in-b2 118))
     ((28 :M) . (:blocks-in-g1 3 :words-in-b1 45 :blocks-in-g2 23 :words-in-b2 46))
     ((28 :Q) . (:blocks-in-g1 4 :words-in-b1 24 :blocks-in-g2 31 :words-in-b2 25))
     ((28 :H) . (:blocks-in-g1 11 :words-in-b1 15 :blocks-in-g2 31 :words-in-b2 16))
     ((29 :L) . (:blocks-in-g1 7 :words-in-b1 116 :blocks-in-g2 7 :words-in-b2 117))
     ((29 :M) . (:blocks-in-g1 21 :words-in-b1 45 :blocks-in-g2 7 :words-in-b2 46))
     ((29 :Q) . (:blocks-in-g1 1 :words-in-b1 23 :blocks-in-g2 37 :words-in-b2 24))
     ((29 :H) . (:blocks-in-g1 19 :words-in-b1 15 :blocks-in-g2 26 :words-in-b2 16))
     ((30 :L) . (:blocks-in-g1 5 :words-in-b1 115 :blocks-in-g2 10 :words-in-b2 116))
     ((30 :M) . (:blocks-in-g1 19 :words-in-b1 47 :blocks-in-g2 10 :words-in-b2 48))
     ((30 :Q) . (:blocks-in-g1 15 :words-in-b1 24 :blocks-in-g2 25 :words-in-b2 25))
     ((30 :H) . (:blocks-in-g1 23 :words-in-b1 15 :blocks-in-g2 25 :words-in-b2 16))
     ((31 :L) . (:blocks-in-g1 13 :words-in-b1 115 :blocks-in-g2 3 :words-in-b2 116))
     ((31 :M) . (:blocks-in-g1 2 :words-in-b1 46 :blocks-in-g2 29 :words-in-b2 47))
     ((31 :Q) . (:blocks-in-g1 42 :words-in-b1 24 :blocks-in-g2 1 :words-in-b2 25))
     ((31 :H) . (:blocks-in-g1 23 :words-in-b1 15 :blocks-in-g2 28 :words-in-b2 16))
     ((32 :L) . (:blocks-in-g1 17 :words-in-b1 115))
     ((32 :M) . (:blocks-in-g1 10 :words-in-b1 46 :blocks-in-g2 23 :words-in-b2 47))
     ((32 :Q) . (:blocks-in-g1 10 :words-in-b1 24 :blocks-in-g2 35 :words-in-b2 25))
     ((32 :H) . (:blocks-in-g1 19 :words-in-b1 15 :blocks-in-g2 35 :words-in-b2 16))
     ((33 :L) . (:blocks-in-g1 17 :words-in-b1 115 :blocks-in-g2 1 :words-in-b2 116))
     ((33 :M) . (:blocks-in-g1 14 :words-in-b1 46 :blocks-in-g2 21 :words-in-b2 47))
     ((33 :Q) . (:blocks-in-g1 29 :words-in-b1 24 :blocks-in-g2 19 :words-in-b2 25))
     ((33 :H) . (:blocks-in-g1 11 :words-in-b1 15 :blocks-in-g2 46 :words-in-b2 16))
     ((34 :L) . (:blocks-in-g1 13 :words-in-b1 115 :blocks-in-g2 6 :words-in-b2 116))
     ((34 :M) . (:blocks-in-g1 14 :words-in-b1 46 :blocks-in-g2 23 :words-in-b2 47))
     ((34 :Q) . (:blocks-in-g1 44 :words-in-b1 24 :blocks-in-g2 7 :words-in-b2 25))
     ((34 :H) . (:blocks-in-g1 59 :words-in-b1 16 :blocks-in-g2 1 :words-in-b2 17))
     ((35 :L) . (:blocks-in-g1 12 :words-in-b1 121 :blocks-in-g2 7 :words-in-b2 122))
     ((35 :M) . (:blocks-in-g1 12 :words-in-b1 47 :blocks-in-g2 26 :words-in-b2 48))
     ((35 :Q) . (:blocks-in-g1 39 :words-in-b1 24 :blocks-in-g2 14 :words-in-b2 25))
     ((35 :H) . (:blocks-in-g1 22 :words-in-b1 15 :blocks-in-g2 41 :words-in-b2 16))
     ((36 :L) . (:blocks-in-g1 6 :words-in-b1 121 :blocks-in-g2 14 :words-in-b2 122))
     ((36 :M) . (:blocks-in-g1 6 :words-in-b1 47 :blocks-in-g2 34 :words-in-b2 48))
     ((36 :Q) . (:blocks-in-g1 46 :words-in-b1 24 :blocks-in-g2 10 :words-in-b2 25))
     ((36 :H) . (:blocks-in-g1 2 :words-in-b1 15 :blocks-in-g2 64 :words-in-b2 16))
     ((37 :L) . (:blocks-in-g1 17 :words-in-b1 122 :blocks-in-g2 4 :words-in-b2 123))
     ((37 :M) . (:blocks-in-g1 29 :words-in-b1 46 :blocks-in-g2 14 :words-in-b2 47))
     ((37 :Q) . (:blocks-in-g1 49 :words-in-b1 24 :blocks-in-g2 10 :words-in-b2 25))
     ((37 :H) . (:blocks-in-g1 24 :words-in-b1 15 :blocks-in-g2 46 :words-in-b2 16))
     ((38 :L) . (:blocks-in-g1 4 :words-in-b1 122 :blocks-in-g2 18 :words-in-b2 123))
     ((38 :M) . (:blocks-in-g1 13 :words-in-b1 46 :blocks-in-g2 32 :words-in-b2 47))
     ((38 :Q) . (:blocks-in-g1 48 :words-in-b1 24 :blocks-in-g2 14 :words-in-b2 25))
     ((38 :H) . (:blocks-in-g1 42 :words-in-b1 15 :blocks-in-g2 32 :words-in-b2 16))
     ((39 :L) . (:blocks-in-g1 20 :words-in-b1 117 :blocks-in-g2 4 :words-in-b2 118))
     ((39 :M) . (:blocks-in-g1 40 :words-in-b1 47 :blocks-in-g2 7 :words-in-b2 48))
     ((39 :Q) . (:blocks-in-g1 43 :words-in-b1 24 :blocks-in-g2 22 :words-in-b2 25))
     ((39 :H) . (:blocks-in-g1 10 :words-in-b1 15 :blocks-in-g2 67 :words-in-b2 16))
     ((40 :L) . (:blocks-in-g1 19 :words-in-b1 118 :blocks-in-g2 6 :words-in-b2 119))
     ((40 :M) . (:blocks-in-g1 18 :words-in-b1 47 :blocks-in-g2 31 :words-in-b2 48))
     ((40 :Q) . (:blocks-in-g1 34 :words-in-b1 24 :blocks-in-g2 34 :words-in-b2 25))
     ((40 :H) . (:blocks-in-g1 20 :words-in-b1 15 :blocks-in-g2 61 :words-in-b2 16)))
   :test #'equalp)
  "For VERSION and ERROR-CORRECTION-MODE, plist containing:
  the number of blocks in group 1, the number of 8-bit words in a
  block of group 1, the number of blocks in group 2, and finally the
  number of 8-bit words in a block of group 2.")


(defvar *remainders*
  (make-array 41 :initial-contents '(0 0 7 7 7 7 7 0 0 0 0 0 0 0 3 3 3 3 3 3 3 4 4 4 4 4 4 4 3 3
				     3 3 3 3 3 0 0 0 0 0 0))
  "Number of bits to add at the end of the binary representation of the interleaved data.")

(defvar *alignment-pattern-centers*
  (make-array 40 :initial-contents 
	      '(()
		( 6 18)
		( 6 22)
		( 6 26)
		( 6 30)
		( 6 34)
		( 6 22 38)
		( 6 24 42)
		( 6 26 46)
		( 6 28 50)
		( 6 30 54)
		( 6 32 58)
		( 6 34 62)
		( 6 26 46 66)
		( 6 26 48 70)
		( 6 26 50 74)
		( 6 30 54 78)
		( 6 30 56 82)
		( 6 30 58 86)
		( 6 34 62 90)
		( 6 28 50 72 94)
		( 6 26 50 74 98)
		( 6 30 54 78 102)
		( 6 28 54 80 106)
		( 6 32 58 84 110)
		( 6 30 58 86 114)
		( 6 34 62 90 118)
		( 6 26 50 74 98 122)
		( 6 30 54 78 102 126)
		( 6 26 52 78 104 130)
		( 6 30 56 82 108 134)
		( 6 34 60 86 112 138)
		( 6 30 58 86 114 142)
		( 6 34 62 90 118 146)
		( 6 30 54 78 102 126 150)
		( 6 24 50 76 102 128 154)
		( 6 28 54 80 106 132 158)
		( 6 32 58 84 110 136 162)
		( 6 26 54 82 110 138 166)
		( 6 30 58 86 114 142 170)))
  "alist with VERSION as key and a list of rows/columns where the center of the alignment patterns
  might be placed.")

